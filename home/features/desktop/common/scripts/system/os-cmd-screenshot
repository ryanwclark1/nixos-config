#!/usr/bin/env bash

# Wrapper script for unified screenshot.sh
# Maintains compatibility with os-cmd-screenshot interface

# Load XDG directories
[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs

# Set screenshot directory from environment
export SCREENSHOTS_DIR="${OS_SCREENSHOT_DIR:-${XDG_PICTURES_DIR:-$HOME/Pictures}}/Screenshots"

# Ensure directory exists
mkdir -p "$SCREENSHOTS_DIR" || {
  notify-send "Screenshot directory does not exist: $SCREENSHOTS_DIR" -u critical -t 3000
  exit 1
}

# Get script directory to find screenshot.sh
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCREENSHOT_SCRIPT="${SCRIPT_DIR}/../wayland/screenshot.sh"

# Fallback to common location if not found
if [[ ! -f "$SCREENSHOT_SCRIPT" ]]; then
  SCREENSHOT_SCRIPT="${HOME}/.local/bin/scripts/wayland/screenshot.sh"
fi

# If still not found, try to find it in PATH
if [[ ! -f "$SCREENSHOT_SCRIPT" ]]; then
  SCREENSHOT_SCRIPT="$(command -v screenshot.sh 2>/dev/null || echo "")"
fi

if [[ -z "$SCREENSHOT_SCRIPT" || ! -f "$SCREENSHOT_SCRIPT" ]]; then
  notify-send "Screenshot Error" "screenshot.sh not found" -u critical -t 3000
  exit 1
fi

# Parse arguments
MODE="${1:-smart}"
PROCESSING="${2:-slurp}"

# Map old modes to new modes
case "$MODE" in
  region)
    SCREENSHOT_MODE="area"
    ;;
  windows)
    SCREENSHOT_MODE="windows"
    ;;
  fullscreen)
    SCREENSHOT_MODE="fullscreen"
    ;;
  smart|*)
    SCREENSHOT_MODE="smart"
    ;;
esac

# Build arguments for screenshot.sh
ARGS=("$SCREENSHOT_MODE" "--freeze")

# Map PROCESSING to options
case "$PROCESSING" in
  clipboard)
    ARGS+=("--clipboard-only")
    ;;
  slurp|*)
    ARGS+=("--satty")
    ;;
esac

# Execute unified screenshot script
exec "$SCREENSHOT_SCRIPT" "${ARGS[@]}"
