# vim:set ft=tmux:
# WAN IP Plugin for tmux-forceline
# Enhanced WAN IP detection with intelligent caching and multiple providers

%hidden MODULE_NAME="wan_ip"

# Plugin metadata
set -g @_fl_plugin_wan_ip_version "2.0.0"
set -g @_fl_plugin_wan_ip_description "WAN IP detection with intelligent caching and multiple providers"

# WAN IP configuration - Enhanced with geographical information
set -ogq @forceline_wan_ip_cache_ttl "900"           # Cache TTL in seconds (15 minutes)
set -ogq @forceline_wan_ip_timeout "3"              # Request timeout in seconds
set -ogq @forceline_wan_ip_format "ip"              # Output format: ip, geo, compact, full
set -ogq @forceline_wan_ip_show_status "no"         # Show cache status (FRESH/CACHED/STALE)

# Base24 color configuration for WAN IP states
set -ogq @forceline_wan_ip_online_fg "#{@fl_fg}"
set -ogq @forceline_wan_ip_cached_fg "#{@fl_fg}"
set -ogq @forceline_wan_ip_stale_fg "#{@fl_base00}"
set -ogq @forceline_wan_ip_offline_fg "#{@fl_base00}"

set -ogq @forceline_wan_ip_online_bg "#{@fl_success}"     # green - fresh IP
set -ogq @forceline_wan_ip_cached_bg "#{@fl_surface_0}"   # normal - cached IP
set -ogq @forceline_wan_ip_stale_bg "#{@fl_warning}"      # orange - stale cache
set -ogq @forceline_wan_ip_offline_bg "#{@fl_error}"      # red - failed to fetch

# Dynamic color selection simplified for now
set -ogq @forceline_wan_ip_fg_color "#{@forceline_wan_ip_online_fg}"
set -ogq @forceline_wan_ip_bg_color "#{@forceline_wan_ip_cached_bg}"

# Plugin configuration using simple curl fallback
set -ogq "@forceline_${MODULE_NAME}_icon" "ó°–‚ "
set -ogq "@forceline_${MODULE_NAME}_color" "#{@fl_base0C}"  # cyan theme
set -ogq "@forceline_${MODULE_NAME}_text_fg" "#{@forceline_wan_ip_fg_color}"
set -ogq "@forceline_${MODULE_NAME}_text_bg" "#{@forceline_wan_ip_bg_color}"

# WAN IP display format using enhanced script with multiple options
set -ogq "@forceline_${MODULE_NAME}_text" " #(/home/administrator/.config/tmux/plugins/tmux-forceline/modules/wan_ip/scripts/wan_ip_enhanced.sh)"

# Load the universal status module renderer
source -F "#{d:current_file}/../../utils/status_module.conf"

# Register plugin capabilities
set -ag @_fl_plugin_capabilities "wan_ip_detection,intelligent_caching,multiple_providers,status_indication"