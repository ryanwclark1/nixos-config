# vim:set ft=tmux:
# CPU Plugin for tmux-forceline
# Enhanced CPU monitoring with temperature and load tracking

%hidden MODULE_NAME="cpu"

# Plugin metadata
set -g @_fl_plugin_cpu_version "2.0.0"
set -g @_fl_plugin_cpu_description "Enhanced CPU monitoring with temperature"

# CPU monitoring configuration
set -ogq @forceline_cpu_temp_enabled "yes"
set -ogq @forceline_cpu_temp_unit "celsius"  # celsius, fahrenheit
set -ogq @forceline_cpu_update_interval "2"
set -ogq @forceline_cpu_high_threshold "80"
set -ogq @forceline_cpu_critical_threshold "90"

# Base24 color configuration
set -ogq @forceline_cpu_low_fg "#{@fl_fg}"
set -ogq @forceline_cpu_medium_fg "#{@fl_fg}"
set -ogq @forceline_cpu_high_fg "#{@fl_base00}"
set -ogq @forceline_cpu_critical_fg "#{@fl_base00}"

set -ogq @forceline_cpu_low_bg "#{@fl_surface_0}"
set -ogq @forceline_cpu_medium_bg "#{@fl_base0A}"  # yellow
set -ogq @forceline_cpu_high_bg "#{@fl_base09}"    # orange
set -ogq @forceline_cpu_critical_bg "#{@fl_base08}" # red

# Dynamic color selection based on CPU usage
set -ogq @forceline_cpu_fg_color "#([ $(#{cpu_percentage} | cut -d'%' -f1) -ge #{@forceline_cpu_critical_threshold} ] && echo '#{@forceline_cpu_critical_fg}' || [ $(#{cpu_percentage} | cut -d'%' -f1) -ge #{@forceline_cpu_high_threshold} ] && echo '#{@forceline_cpu_high_fg}' || echo '#{@forceline_cpu_low_fg}')"

set -ogq @forceline_cpu_bg_color "#([ $(#{cpu_percentage} | cut -d'%' -f1) -ge #{@forceline_cpu_critical_threshold} ] && echo '#{@forceline_cpu_critical_bg}' || [ $(#{cpu_percentage} | cut -d'%' -f1) -ge #{@forceline_cpu_high_threshold} ] && echo '#{@forceline_cpu_high_bg}' || echo '#{@forceline_cpu_low_bg}')"

# Plugin configuration
set -ogq "@forceline_${MODULE_NAME}_icon" "ó°› "
set -ogq "@forceline_${MODULE_NAME}_color" "#{@fl_base0A}"  # yellow theme
set -ogq "@forceline_${MODULE_NAME}_text_fg" "#{@forceline_cpu_fg_color}"
set -ogq "@forceline_${MODULE_NAME}_text_bg" "#{@forceline_cpu_bg_color}"

# CPU display format with optional temperature
%if "#{==:#{@forceline_cpu_temp_enabled},yes}"
  set -ogq "@forceline_${MODULE_NAME}_text" " #{cpu_percentage}#{?#{>=:#{cpu_temp},0}, #{cpu_temp},}"
%else
  set -ogq "@forceline_${MODULE_NAME}_text" " #{cpu_percentage}"
%endif

# Load the universal status module renderer
source -F "#{d:current_file}/../../utils/status_module.conf"

# Register plugin capabilities
set -ag @_fl_plugin_capabilities "cpu_monitoring,temperature_monitoring,dynamic_colors"