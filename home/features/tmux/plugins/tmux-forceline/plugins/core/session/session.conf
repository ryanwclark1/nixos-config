# vim:set ft=tmux:
# Session Plugin for tmux-forceline
# Displays current tmux session information with dynamic styling

%hidden MODULE_NAME="session"

# Plugin metadata
set -g @_fl_plugin_session_version "2.0.0"
set -g @_fl_plugin_session_description "tmux session information display"

# Session display configuration
set -ogq @forceline_session_show_name "yes"
set -ogq @forceline_session_show_index "no"
set -ogq @forceline_session_show_client_count "no"
set -ogq @forceline_session_max_name_length "15"

# Base24 color configuration
set -ogq @forceline_session_normal_fg "#{@fl_fg}"
set -ogq @forceline_session_active_fg "#{@fl_base00}"
set -ogq @forceline_session_multiple_fg "#{@fl_base00}"

set -ogq @forceline_session_normal_bg "#{@fl_surface_0}"
set -ogq @forceline_session_active_bg "#{@fl_primary}"    # blue - active session
set -ogq @forceline_session_multiple_bg "#{@fl_accent}"  # brown - multiple sessions

# Dynamic color selection based on session state
set -ogq @forceline_session_fg_color "#(session_count=$(tmux list-sessions 2>/dev/null | wc -l); if [ \"$session_count\" -gt 1 ]; then echo '#{@forceline_session_multiple_fg}'; else echo '#{@forceline_session_active_fg}'; fi)"

set -ogq @forceline_session_bg_color "#(session_count=$(tmux list-sessions 2>/dev/null | wc -l); if [ \"$session_count\" -gt 1 ]; then echo '#{@forceline_session_multiple_bg}'; else echo '#{@forceline_session_active_bg}'; fi)"

# Plugin configuration
set -ogq "@forceline_${MODULE_NAME}_icon" "ó±‚¬ "
set -ogq "@forceline_${MODULE_NAME}_color" "#{@fl_primary}"  # blue theme
set -ogq "@forceline_${MODULE_NAME}_text_fg" "#{@forceline_session_fg_color}"
set -ogq "@forceline_${MODULE_NAME}_text_bg" "#{@forceline_session_bg_color}"

# Session display format
%if "#{==:#{@forceline_session_show_client_count},yes}"
  %if "#{==:#{@forceline_session_show_index},yes}"
    set -ogq "@forceline_${MODULE_NAME}_text" " #S[#I] (#{session_windows}w)"
  %else
    set -ogq "@forceline_${MODULE_NAME}_text" " #S (#{session_windows}w)"
  %endif
%elif "#{==:#{@forceline_session_show_index},yes}"
  set -ogq "@forceline_${MODULE_NAME}_text" " #S[#I]"
%else
  set -ogq "@forceline_${MODULE_NAME}_text" " #{=#{@forceline_session_max_name_length}:#S}"
%endif

# Load the universal status module renderer
source -F "#{d:current_file}/../../utils/status_module.conf"

# Register plugin capabilities
set -ag @_fl_plugin_capabilities "session_monitoring,dynamic_colors,client_counting"