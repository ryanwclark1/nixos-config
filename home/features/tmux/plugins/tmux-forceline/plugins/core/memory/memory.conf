# vim:set ft=tmux:
# Memory Plugin for tmux-forceline
# RAM and swap monitoring with usage-based theming

%hidden MODULE_NAME="memory"

# Plugin metadata
set -g @_fl_plugin_memory_version "2.0.0"
set -g @_fl_plugin_memory_description "RAM and swap usage monitoring"

# Memory monitoring configuration
set -ogq @forceline_memory_format "percentage"  # percentage, absolute, both
set -ogq @forceline_memory_unit "GB"           # GB, MB, auto
set -ogq @forceline_memory_swap_enabled "yes"
set -ogq @forceline_memory_high_threshold "80"
set -ogq @forceline_memory_critical_threshold "95"

# Base24 color configuration
set -ogq @forceline_memory_low_fg "#{@fl_fg}"
set -ogq @forceline_memory_medium_fg "#{@fl_fg}"
set -ogq @forceline_memory_high_fg "#{@fl_base00}"
set -ogq @forceline_memory_critical_fg "#{@fl_base00}"

set -ogq @forceline_memory_low_bg "#{@fl_surface_0}"
set -ogq @forceline_memory_medium_bg "#{@fl_base0C}"  # cyan
set -ogq @forceline_memory_high_bg "#{@fl_base09}"    # orange
set -ogq @forceline_memory_critical_bg "#{@fl_base08}" # red

# Dynamic color selection based on memory usage
set -ogq @forceline_memory_fg_color "#([ $(#{ram_percentage} | cut -d'%' -f1) -ge #{@forceline_memory_critical_threshold} ] && echo '#{@forceline_memory_critical_fg}' || [ $(#{ram_percentage} | cut -d'%' -f1) -ge #{@forceline_memory_high_threshold} ] && echo '#{@forceline_memory_high_fg}' || echo '#{@forceline_memory_low_fg}')"

set -ogq @forceline_memory_bg_color "#([ $(#{ram_percentage} | cut -d'%' -f1) -ge #{@forceline_memory_critical_threshold} ] && echo '#{@forceline_memory_critical_bg}' || [ $(#{ram_percentage} | cut -d'%' -f1) -ge #{@forceline_memory_high_threshold} ] && echo '#{@forceline_memory_high_bg}' || echo '#{@forceline_memory_low_bg}')"

# Plugin configuration
set -ogq "@forceline_${MODULE_NAME}_icon" "ó°˜š "
set -ogq "@forceline_${MODULE_NAME}_color" "#{@fl_base0C}"  # cyan theme
set -ogq "@forceline_${MODULE_NAME}_text_fg" "#{@forceline_memory_fg_color}"
set -ogq "@forceline_${MODULE_NAME}_text_bg" "#{@forceline_memory_bg_color}"

# Memory display format
%if "#{==:#{@forceline_memory_format},percentage}"
  set -ogq "@forceline_${MODULE_NAME}_text" " #{ram_percentage}"
%elif "#{==:#{@forceline_memory_format},absolute}"
  set -ogq "@forceline_${MODULE_NAME}_text" " #{ram_usage}/#{ram_total}"
%else
  set -ogq "@forceline_${MODULE_NAME}_text" " #{ram_percentage} (#{ram_usage})"
%endif

# Load the universal status module renderer
source -F "#{d:current_file}/../../utils/status_module.conf"

# Register plugin capabilities
set -ag @_fl_plugin_capabilities "memory_monitoring,swap_monitoring,dynamic_colors"