# vim:set ft=tmux:
# Battery Plugin for tmux-forceline
# Cross-platform battery monitoring with dynamic colors

%hidden MODULE_NAME="battery"

# Plugin metadata
set -g @_fl_plugin_battery_version "2.0.0"
set -g @_fl_plugin_battery_description "Cross-platform battery monitoring with status-based theming"

# Battery monitoring configuration
set -ogq @forceline_battery_show_percentage "yes"
set -ogq @forceline_battery_show_status "yes"
set -ogq @forceline_battery_low_threshold "20"
set -ogq @forceline_battery_critical_threshold "10"
set -ogq @forceline_battery_update_interval "5"

# Base24 color configuration for battery states
set -ogq @forceline_battery_normal_fg "#{@fl_fg}"
set -ogq @forceline_battery_low_fg "#{@fl_base00}"
set -ogq @forceline_battery_critical_fg "#{@fl_base00}"
set -ogq @forceline_battery_charging_fg "#{@fl_base00}"

set -ogq @forceline_battery_normal_bg "#{@fl_surface_0}"
set -ogq @forceline_battery_low_bg "#{@fl_warning}"      # orange
set -ogq @forceline_battery_critical_bg "#{@fl_error}"   # red
set -ogq @forceline_battery_charging_bg "#{@fl_success}" # green

# Dynamic color selection based on battery level and charging status
set -ogq @forceline_battery_fg_color "#(battery_pct=$(#{battery_percentage} | cut -d'%' -f1 2>/dev/null || echo '100'); battery_status=$(#{battery_status} 2>/dev/null || echo 'unknown'); if [ \"$battery_status\" = \"charging\" ] || [ \"$battery_status\" = \"charged\" ]; then echo '#{@forceline_battery_charging_fg}'; elif [ \"$battery_pct\" -le #{@forceline_battery_critical_threshold} ] 2>/dev/null; then echo '#{@forceline_battery_critical_fg}'; elif [ \"$battery_pct\" -le #{@forceline_battery_low_threshold} ] 2>/dev/null; then echo '#{@forceline_battery_low_fg}'; else echo '#{@forceline_battery_normal_fg}'; fi)"

set -ogq @forceline_battery_bg_color "#(battery_pct=$(#{battery_percentage} | cut -d'%' -f1 2>/dev/null || echo '100'); battery_status=$(#{battery_status} 2>/dev/null || echo 'unknown'); if [ \"$battery_status\" = \"charging\" ] || [ \"$battery_status\" = \"charged\" ]; then echo '#{@forceline_battery_charging_bg}'; elif [ \"$battery_pct\" -le #{@forceline_battery_critical_threshold} ] 2>/dev/null; then echo '#{@forceline_battery_critical_bg}'; elif [ \"$battery_pct\" -le #{@forceline_battery_low_threshold} ] 2>/dev/null; then echo '#{@forceline_battery_low_bg}'; else echo '#{@forceline_battery_normal_bg}'; fi)"

# Plugin configuration using battery format variables
set -ogq "@forceline_${MODULE_NAME}_icon" "#{battery_icon} "
set -ogq "@forceline_${MODULE_NAME}_color" "#{@fl_base0B}"  # green theme
set -ogq "@forceline_${MODULE_NAME}_text_fg" "#{@forceline_battery_fg_color}"
set -ogq "@forceline_${MODULE_NAME}_text_bg" "#{@forceline_battery_bg_color}"

# Battery display format with optional status
%if "#{==:#{@forceline_battery_show_percentage},yes}"
  set -ogq "@forceline_${MODULE_NAME}_text" " #{battery_percentage}"
%else
  set -ogq "@forceline_${MODULE_NAME}_text" ""
%endif

# Load the battery module to register format variables
source -F "#{d:current_file}/../../../modules/battery/battery.tmux"

# Load the universal status module renderer
source -F "#{d:current_file}/../../utils/status_module.conf"

# Register plugin capabilities
set -ag @_fl_plugin_capabilities "battery_monitoring,cross_platform,dynamic_colors,status_detection"