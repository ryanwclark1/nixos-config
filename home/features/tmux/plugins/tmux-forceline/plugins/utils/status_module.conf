# vim:set ft=tmux:
# Universal Status Module Renderer for tmux-forceline
# Base24-compatible module rendering system

# Validate MODULE_NAME is set
%if "#{==:#{MODULE_NAME},}"
  display-message "Error: MODULE_NAME not set for status module"
%endif

# Connection style for seamless module chaining
set -gqF @_fl_connect_style \
  "#{?#{==:#{@forceline_status_connect_separator},yes},,#[bg=default]}"

# Default fallback configurations using Base24 colors
set -ogqF "@forceline_status_${MODULE_NAME}_icon_fg" "#{@fl_base00}"  # dark on light icon
set -ogqF "@forceline_status_${MODULE_NAME}_text_fg" "#{@fl_fg}"      # default text color

# Icon background defaults to module theme color
%if "#{==:#{@forceline_status_${MODULE_NAME}_icon_bg},}"
  set -gqF "@forceline_status_${MODULE_NAME}_icon_bg" "#{@forceline_${MODULE_NAME}_color}"
%endif

# Text background with intelligent fallback
%if "#{==:#{@forceline_status_${MODULE_NAME}_text_bg},}"
  set -gqF @_fl_module_text_bg "#{@fl_surface_0}"  # default surface
%else
  set -gqF @_fl_module_text_bg "#{@forceline_status_${MODULE_NAME}_text_bg}"
%endif

# Build the complete status module format
# Structure: [separator][icon][middle_sep][text][separator]

# Left separator with connection style
set -gF "@forceline_status_${MODULE_NAME}" \
  "#[fg=#{@forceline_status_${MODULE_NAME}_icon_bg}]#{@_fl_connect_style}#{@forceline_status_left_separator}"

# Icon section with colors and content
set -agF "@forceline_status_${MODULE_NAME}" \
  "#[fg=#{@forceline_status_${MODULE_NAME}_icon_fg},bg=#{@forceline_status_${MODULE_NAME}_icon_bg}]#{@forceline_${MODULE_NAME}_icon}"

# Middle separator between icon and text
set -agF "@forceline_status_${MODULE_NAME}" \
  "#{@forceline_status_middle_separator}"

# Text section with dynamic coloring
set -agF "@forceline_status_${MODULE_NAME}" \
  "#[fg=#{@forceline_status_${MODULE_NAME}_text_fg},bg=#{@_fl_module_text_bg}]"

# Actual text content
set -ag "@forceline_status_${MODULE_NAME}" "#{E:@forceline_${MODULE_NAME}_text}"

# Right separator with connection style
set -agF "@forceline_status_${MODULE_NAME}" \
  "#[fg=#{@_fl_module_text_bg}]#{@_fl_connect_style}#{@forceline_status_right_separator}"

# Cleanup temporary variables
set -ug @_fl_connect_style
set -ug @_fl_module_text_bg

# Debug information (only shown if debug mode enabled)
%if "#{==:#{@forceline_debug_modules},yes}"
  display-message "Loaded module: ${MODULE_NAME} with colors icon_bg=#{@forceline_status_${MODULE_NAME}_icon_bg} text_bg=#{@_fl_module_text_bg}"
%endif