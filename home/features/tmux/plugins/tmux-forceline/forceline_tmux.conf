# vim:set ft=tmux:
# tmux-forceline Main Configuration
# Independent implementation with Base24 theming

# Load theme system first (must come before any color references)
source -F "#{d:current_file}/themes/theme_loader.conf"

# Ensure theme is loaded before proceeding
%if "#{!=:#{@forceline_theme_loaded},yes}"
  display-message "Error: Theme system failed to load"
%endif

# Set Base24 color assignments after theme loads
%if "#{==:#{@forceline_menu_selected_style},}"
  set -g @forceline_menu_selected_style "fg=#{@fl_fg},bold,bg=#{@fl_surface_1}"
%endif

%if "#{==:#{@forceline_pane_border_style},}"
  set -g @forceline_pane_border_style "fg=#{@fl_surface_1}"
%endif

%if "#{==:#{@forceline_pane_active_border_style},}"
  set -g @forceline_pane_active_border_style "##{?pane_in_mode,fg=#{@fl_primary},##{?pane_synchronized,fg=#{@fl_secondary},fg=#{@fl_primary}}}"
%endif

%if "#{==:#{@forceline_pane_color},}"
  set -g @forceline_pane_color "#{@fl_success}"
%endif

%if "#{==:#{@forceline_pane_background_color},}"
  set -g @forceline_pane_background_color "#{@fl_surface_0}"
%endif

%if "#{==:#{@forceline_window_text_color},}"
  set -g @forceline_window_text_color "#{@fl_surface_0}"
%endif

%if "#{==:#{@forceline_window_number_color},}"
  set -g @forceline_window_number_color "#{@fl_surface_2}"
%endif

%if "#{==:#{@forceline_window_current_text_color},}"
  set -g @forceline_window_current_text_color "#{@fl_surface_1}"
%endif

%if "#{==:#{@forceline_window_current_number_color},}"
  set -g @forceline_window_current_number_color "#{@fl_primary}"
%endif

%if "#{==:#{@forceline_status_module_text_bg},}"
  set -g @forceline_status_module_text_bg "#{@fl_surface_0}"
%endif

# Status background configuration
%if "#{==:#{@forceline_status_background},default}"
  set -gF @_fl_status_bg "#{@fl_mantle}"
  set -gF status-style "bg=#{@_fl_status_bg},fg=#{@fl_fg}"
  %hidden FL_MESSAGE_BACKGROUND="#{@fl_surface_1}"
%elif "#{==:#{@forceline_status_background},none}"
  set -g status-style "default"
  set -g @_fl_status_bg "none"
  %hidden FL_MESSAGE_BACKGROUND="default"
%else
  set -gF status-style "bg=#{E:@forceline_status_background},fg=#{@fl_fg}"
  set -gF @_fl_status_bg "#{E:@forceline_status_background}"
  %hidden FL_MESSAGE_BACKGROUND="#{E:@forceline_status_background}"
%endif

# Load plugin system
%if "#{==:#{@forceline_plugin_auto_load},yes}"
  source -F "#{d:current_file}/plugins/plugin_loader.conf"
%endif

# Legacy status modules (for backward compatibility during migration)
# These will be gradually replaced by the new plugin system
source -F "#{d:current_file}/status/battery.conf"
source -F "#{d:current_file}/status/date_time.conf"
source -F "#{d:current_file}/status/directory.conf"
source -F "#{d:current_file}/status/session.conf"

# Message styling (Base24)
set -gF message-style "fg=#{@fl_info},bg=$FL_MESSAGE_BACKGROUND,align=centre"
set -gF message-command-style "fg=#{@fl_info},bg=$FL_MESSAGE_BACKGROUND,align=centre"

# Menu styling (tmux 3.4+)
%if "#{>=:#{version},3.4}"
  set -gF menu-selected-style "#{E:@forceline_menu_selected_style}"
%endif

# Pane styling (Base24)
set -wgF pane-active-border-style "#{E:@forceline_pane_active_border_style}"
set -wgF pane-border-style "#{E:@forceline_pane_border_style}"

# Pane status configuration (if enabled)
%if "#{==:#{@forceline_pane_status_enabled},yes}"
  set -gq @_fl_p_left ""
  set -gq @_fl_p_middle ""
  set -gq @_fl_p_right ""
  set -gq @_fl_p_number ""
  set -gq @_fl_p_text ""

  %if "#{==:#{@forceline_pane_default_fill},none}"
    set -g @_fl_p_left "#[fg=#{@fl_surface_0},bg=default]#{@forceline_pane_left_separator}"
    set -g @_fl_p_middle "#[fg=#{@fl_fg},bg=#{@fl_surface_0}]#{@forceline_pane_middle_separator}"
    set -g @_fl_p_right "#[fg=#{@fl_surface_0},bg=default]#{@forceline_pane_right_separator}"
    set -g @_fl_p_number "#[fg=#{@fl_fg},bg=#{@fl_surface_0}]##{pane_index}"
    set -g @_fl_p_text "#[fg=#{@fl_fg},bg=#{@fl_surface_0}]#{E:@forceline_pane_default_text}"
  %elif "#{==:#{@forceline_pane_default_fill},all}"
    set -g @_fl_p_left "#[fg=#{E:@forceline_pane_color},bg=default]#{@forceline_pane_left_separator}"
    set -g @_fl_p_middle "#[fg=#{E:@forceline_pane_color},bg=#{E:@forceline_pane_background_color}]#{@forceline_pane_middle_separator}"
    set -g @_fl_p_right "#[fg=#{E:@forceline_pane_color},bg=default]#{@forceline_pane_right_separator}"
    set -g @_fl_p_number "#[fg=#{E:@forceline_pane_background_color},bg=#{E:@forceline_pane_color}]##{pane_index}"
    set -g @_fl_p_text "#[fg=#{E:@forceline_pane_background_color},bg=#{E:@forceline_pane_color}]#{E:@forceline_pane_default_text}"
  %elif "#{==:#{@forceline_pane_default_fill},number}"
    %if "#{==:#{@forceline_pane_number_position},left}"
      set -g @_fl_p_left "#[fg=#{E:@forceline_pane_color},bg=default]#{@forceline_pane_left_separator}"
      set -g @_fl_p_right "#[fg=#{E:@forceline_pane_background_color},bg=default]#{@forceline_pane_right_separator}"
    %else
      set -g @_fl_p_left "#[fg=#{E:@forceline_pane_background_color},bg=default]#{@forceline_pane_left_separator}"
      set -g @_fl_p_right "#[fg=#{E:@forceline_pane_color},bg=default]#{@forceline_pane_right_separator}"
    %endif
    set -g @_fl_p_middle "#[fg=#{E:@forceline_pane_color},bg=#{E:@forceline_pane_background_color}]#{@forceline_pane_middle_separator}"
    set -g @_fl_p_number "#[fg=#{E:@forceline_pane_background_color},bg=#{E:@forceline_pane_color}]##{pane_index}"
    set -g @_fl_p_text "#[fg=#{E:@forceline_pane_color},bg=#{E:@forceline_pane_background_color}]#{E:@forceline_pane_default_text}"
  %endif

  %if "#{==:#{@forceline_pane_number_position},left}"
    set -wgF pane-border-format "#{E:@_fl_p_left}#{E:@_fl_p_number}#{E:@_fl_p_middle} #{E:@_fl_p_text}#{E:@_fl_p_right}"
  %else
    set -wgF pane-border-format "#{E:@_fl_p_left}#{E:@_fl_p_text} #{E:@_fl_p_middle}#{E:@_fl_p_number}#{E:@_fl_p_right}"
  %endif

  # Cleanup pane variables
  set -ug @_fl_p_left
  set -ug @_fl_p_middle
  set -ug @_fl_p_right
  set -ug @_fl_p_number
  set -ug @_fl_p_text
%endif

# Popup styling (tmux 3.4+)
%if "#{>=:#{version},3.4}"
  set -gF popup-style "bg=#{@fl_bg},fg=#{@fl_fg}"
  set -gF popup-border-style "fg=#{@fl_surface_1}"
%endif

# Window status styling
%if "#{!=:#{@forceline_window_status_style},none}"
  # Window separators based on style
  %if "#{==:#{@forceline_window_status_style},basic}"
    set -gq @forceline_window_left_separator " "
    set -gq @forceline_window_middle_separator " "
    set -gq @forceline_window_right_separator " "
  %elif "#{==:#{@forceline_window_status_style},rounded}"
    set -gq @forceline_window_left_separator "#[fg=#{@_fl_status_bg},reverse]#[none]"
    set -gq @forceline_window_middle_separator " "
    set -gq @forceline_window_right_separator "#[fg=#{@_fl_status_bg},reverse]#[none]"
  %elif "#{==:#{@forceline_window_status_style},slanted}"
    set -gq @forceline_window_left_separator "#[fg=#{@_fl_status_bg},reverse]#[none]"
    %if "#{==:#{@forceline_window_number_position},left}"
      set -gq @forceline_window_middle_separator "#[fg=#{@forceline_window_number_color},bg=#{@forceline_window_text_color}]"
      set -gq @forceline_window_current_middle_separator "#[fg=#{@forceline_window_current_number_color},bg=#{@forceline_window_current_text_color}]"
    %else
      set -gq @forceline_window_middle_separator " #[fg=#{@forceline_window_number_color},bg=#{@forceline_window_text_color}]"
      set -gq @forceline_window_current_middle_separator " #[fg=#{@forceline_window_current_number_color},bg=#{@forceline_window_current_text_color}]"
    %endif
    set -gq @forceline_window_right_separator "#[fg=#{@_fl_status_bg},reverse]â–ˆ#[none]"
  %endif

  # Set current window separators
  set -ogqF @forceline_window_current_left_separator "#{@forceline_window_left_separator}"
  set -ogqF @forceline_window_current_middle_separator "#{@forceline_window_middle_separator}"
  set -ogqF @forceline_window_current_right_separator "#{@forceline_window_right_separator}"

  # Window activity and bell styling
  set -gF window-status-activity-style "bg=#{@fl_primary},fg=#{@fl_bg}"
  set -gF window-status-bell-style "bg=#{@fl_accent},fg=#{@fl_bg}"

  # Window flags configuration
  %if "#{==:#{@forceline_window_flags},icon}"
    set -gqF @_fl_w_flags "#{E:@forceline_window_flags_icon_format} "
  %elif "#{==:#{@forceline_window_flags},text}"
    set -gq @_fl_w_flags "#F"
  %else
    set -gq @_fl_w_flags ""
  %endif

  # Window status format (non-current)
  set -g @_fl_w_number_style "#[fg=#{@fl_base00},bg=#{@forceline_window_number_color}]"
  set -g @_fl_w_text_style "#[fg=#{@fl_fg},bg=#{@forceline_window_text_color}]"
  
  %if "#{==:#{@forceline_window_number_position},left}"
    set -gF window-status-format "#{E:@_fl_w_number_style}#{E:@forceline_window_left_separator}#{@forceline_window_number}"
    set -agF window-status-format "#{E:@forceline_window_middle_separator}"
    set -agF window-status-format "#{E:@_fl_w_text_style}#{@forceline_window_text}#{@_fl_w_flags}#{E:@forceline_window_right_separator}"
  %else
    set -gF window-status-format "#{E:@_fl_w_text_style}#{E:@forceline_window_left_separator}#{E:@_fl_w_text_style}#{@forceline_window_text}#{@_fl_w_flags}"
    set -agF window-status-format "#{E:@forceline_window_middle_separator}"
    set -agF window-status-format "#{E:@_fl_w_number_style} #{@forceline_window_number}#{E:@forceline_window_right_separator}"
  %endif

  # Current window status format
  set -g @_fl_w_number_style "#[fg=#{@fl_base00},bg=#{@forceline_window_current_number_color}]"
  set -g @_fl_w_text_style "#[fg=#{@fl_fg},bg=#{@forceline_window_current_text_color}]"
  
  %if "#{==:#{@forceline_window_number_position},left}"
    set -gF window-status-current-format "#{E:@_fl_w_number_style}#{E:@forceline_window_current_left_separator}#{@forceline_window_current_number}"
    set -agF window-status-current-format "#{E:@forceline_window_current_middle_separator}"
    set -agF window-status-current-format "#{E:@_fl_w_text_style}#{@forceline_window_current_text}#{@_fl_w_flags}#{E:@forceline_window_current_right_separator}"
  %else
    set -gF window-status-current-format "#{E:@_fl_w_text_style}#{E:@forceline_window_current_left_separator}#{E:@_fl_w_text_style}#{@forceline_window_current_text}#{@_fl_w_flags}"
    set -agF window-status-current-format "#{E:@forceline_window_current_middle_separator}"
    set -agF window-status-current-format "#{E:@_fl_w_number_style} #{@forceline_window_current_number}#{E:@forceline_window_current_right_separator}"
  %endif

  # Cleanup window variables
  set -ug @_fl_w_number_style
  set -ug @_fl_w_text_style
  set -ug @_fl_w_flags
%endif

# Mode styling for copy mode
set -gF mode-style "bg=#{@fl_surface_0},bold"
set -gF clock-mode-colour "#{@fl_primary}"

# Display loading confirmation
%if "#{==:#{@forceline_debug_modules},yes}"
  display-message "tmux-forceline loaded with theme: #{@forceline_theme}"
%endif