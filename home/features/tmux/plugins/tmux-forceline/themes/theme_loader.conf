# vim:set ft=tmux:
# Modern YAML Theme Loader for tmux-forceline v2.0
# Requires yq for YAML processing - no legacy fallbacks

# Initialize theme variables
%if "#{==:#{@forceline_theme},}"
  set -g @forceline_theme "catppuccin-frappe"
%endif

# Check if yq is available (required for v2.0)
set -g @_fl_yq_available "no"
if-shell "command -v yq >/dev/null 2>&1" {
  set -g @_fl_yq_available "yes"
} {
  display-message "Error: yq is required for tmux-forceline v2.0. Install: brew install yq"
  # Exit early if yq not available
}

# YAML-only theme processing
%if "#{==:#{@_fl_yq_available},yes}"
  %if "#{==:#{@forceline_theme},custom}"
    # Custom theme handling
    %if "#{!=:#{@forceline_custom_theme_path},}"
      # Custom YAML theme
      if-shell "test -f '#{E:@forceline_custom_theme_path}'" {
        run-shell "#{d:current_file}/scripts/yaml_parser.sh convert '#{E:@forceline_custom_theme_path}' '#{d:current_file}/generated/custom.conf'"
        source-file "#{d:current_file}/generated/custom.conf"
        set -g @forceline_theme_source "custom_yaml"
      } {
        display-message "Error: Custom YAML theme file not found: #{E:@forceline_custom_theme_path}"
        # Fallback to default
        run-shell "#{d:current_file}/scripts/yaml_parser.sh generate catppuccin-frappe '#{d:current_file}'"
        source-file "#{d:current_file}/generated/catppuccin-frappe.conf"
        set -g @forceline_theme_source "fallback"
      }
    %else
      display-message "Error: Custom theme selected but @forceline_custom_theme_path not set"
      run-shell "#{d:current_file}/scripts/yaml_parser.sh generate catppuccin-frappe '#{d:current_file}'"
      source-file "#{d:current_file}/generated/catppuccin-frappe.conf"
      set -g @forceline_theme_source "fallback"
    %endif
  %else
    # Predefined YAML themes
    if-shell "test -f '#{d:current_file}/yaml/#{@forceline_theme}.yaml'" {
      # Generate if config doesn't exist or YAML is newer
      if-shell "test ! -f '#{d:current_file}/generated/#{@forceline_theme}.conf' || test '#{d:current_file}/yaml/#{@forceline_theme}.yaml' -nt '#{d:current_file}/generated/#{@forceline_theme}.conf'" {
        run-shell "#{d:current_file}/scripts/yaml_parser.sh generate '#{@forceline_theme}' '#{d:current_file}'"
      }
      source-file "#{d:current_file}/generated/#{@forceline_theme}.conf"
      set -g @forceline_theme_source "yaml"
    } {
      display-message "Error: YAML theme '#{@forceline_theme}' not found"
      # Fallback to default
      run-shell "#{d:current_file}/scripts/yaml_parser.sh generate catppuccin-frappe '#{d:current_file}'"
      source-file "#{d:current_file}/generated/catppuccin-frappe.conf"
      set -g @forceline_theme_source "fallback"
    }
  %endif
  set -g @forceline_theme_loaded "yes"
%endif

# Initialize theme-specific status background
%if "#{==:#{@forceline_status_background},default}"
  set -gF @_fl_status_bg "#{@fl_mantle}"
  set -gF status-style "bg=#{@_fl_status_bg},fg=#{@fl_fg}"
%elif "#{==:#{@forceline_status_background},none}"
  set -g status-style "default"
  set -g @_fl_status_bg "none"
%else
  # Treat @forceline_status_background as a format string
  set -gF status-style "bg=#{E:@forceline_status_background},fg=#{@fl_fg}"
  set -gF @_fl_status_bg "#{E:@forceline_status_background}"
%endif